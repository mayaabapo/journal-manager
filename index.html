<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cannabis Journals Reference Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <style>
    :root {
      /* Modernized color palette */
      --bg: #f8f9fa;
      --card: #ffffff;
      --text: #2d3748;
      --text-light: #4a5568;
      --primary: #2d6a4f;
      --primary-light: #40916c;
      --primary-dark: #1b4332;
      --accent: #52b788;
      --success: #40916c;
      --danger: #e63946;
      --warning: #f4a261;
      --border: #e2e8f0;
      --row-alt: #f1f5f9;
      --header-gradient: linear-gradient(135deg, var(--primary), var(--accent));
      
      /* Shadows */
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
      
      /* Border radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1500px;
      margin: 0 auto;
    }

    /* Header Styles */
    header {
      text-align: center;
      margin-bottom: 2.5rem;
      padding: 2.5rem 1.5rem;
      background: var(--header-gradient);
      color: white;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 30%);
      pointer-events: none;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      letter-spacing: -0.025em;
      position: relative;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header p {
      font-size: 1.125rem;
      font-weight: 500;
      max-width: 600px;
      margin: 0 auto;
      opacity: 0.9;
      position: relative;
    }

    /* Navigation Tabs */
    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      border: 2px solid var(--primary);
      background: white;
      color: var(--primary);
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
      box-shadow: var(--shadow-sm);
    }

    .nav-tab:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .nav-tab.active-tab {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-md);
    }

    /* Main Content Sections */
    .content-section {
      display: none;
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      padding: 2rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border);
    }

    .content-section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-dark);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
      box-shadow: var(--shadow-sm);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .btn-secondary:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #2d6a4f;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c1121f;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    /* Tables */
    .table-container {
      background: var(--card);
      border-radius: var(--radius-md);
      overflow-x: auto;
      box-shadow: var(--shadow-sm);
      margin-top: 1.5rem;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    th, td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
      word-wrap: break-word;
      user-select: text;
      text-align: left;
    }

    thead {
      background-color: var(--primary);
      color: white;
      position: sticky;
      top: 0;
    }

    th {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
    }

    tbody tr:nth-child(even) {
      background-color: var(--row-alt);
    }

    tbody tr:hover {
      background-color: #edf2f7;
    }

    td a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
      font-weight: 500;
    }

    td a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .pagination button {
      background: #fff;
      color: var(--primary);
      border: 2px solid var(--primary);
      padding: 0.5rem 1rem;
      font-size: 0.95rem;
      border-radius: 50px;
      font-weight: 600;
      transition: all 0.2s ease;
      cursor: pointer;
      min-width: 40px;
      box-shadow: var(--shadow-sm);
    }

    .pagination button:hover {
      background-color: var(--primary);
      color: #fff;
      transform: translateY(-1px);
    }

    .pagination button.active {
      background-color: var(--primary);
      color: #fff;
    }

    /* Saved References Actions */
    .saved-actions {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }

    /* Drag and Drop */
    tr[draggable="true"] {
      cursor: move;
    }

    tr.drag-over {
      background-color: #e8f3ee;
      outline: 2px dashed var(--primary);
    }

    /* Preview Section */
    .preview-section {
      margin-top: 2rem;
      background: var(--card);
      border-radius: var(--radius-md);
      padding: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .preview-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-dark);
    }

    .preview-content {
      padding: 1rem;
      background: var(--bg);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      overflow-x: auto;
      font-family: 'Inter', sans-serif;
      color: var(--text);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      header h1 {
        font-size: 2rem;
      }
      
      header {
        padding: 1.5rem 1rem;
      }
      
      .content-section {
        padding: 1.5rem 1rem;
      }
      
      th, td {
        padding: 0.75rem 0.5rem;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--text-light);
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: #cbd5e1;
    }

    .empty-state p {
      margin-top: 0.5rem;
      color: var(--text-light);
    }

    /* Add this to your existing media query or create a new one */
    @media (max-width: 768px) {
      /* Existing mobile styles... */
      
      /* New styles for saved references actions */
      .saved-actions {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem;
        margin-top: 1rem;
      }
      
      .saved-actions .btn {
        width: 100%;
        justify-content: center;
      }
      
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .preview-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }
      
      .preview-header .btn {
        width: 100%;
      }
    }

    /* Add this new media query for very small screens */
    @media (max-width: 480px) {
      .nav-tab {
        width: 100%;
        justify-content: center;
      }
      
      #savedTable th, 
      #savedTable td {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }
      
      #savedTable .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
      
      .preview-content {
        padding: 0.5rem;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Cannabis Journals Reference Generator</h1>
      <p>Generate 100 references from cannabis journals using cannabis-related data, and output them in an HTML reference table.</p>
    </header>

    <nav>
      <button onclick="showTab('generateSection')" class="nav-tab active-tab">
        <i class="bi bi-plus-circle"></i> Generate References
      </button>
      <button onclick="showTab('savedSection')" class="nav-tab">
        <i class="bi bi-bookmark-check"></i> Saved References
      </button>
    </nav>

    <!-- Generate References Section -->
    <section id="generateSection" class="content-section active">
      <div class="section-header">
        <h2 class="section-title">Generate New References</h2>
      </div>
      
      <p>Click the button below to fetch 100 random cannabis-related references.</p>
      
      <button class="btn btn-primary" onclick="generateReferences()">
        <i class="bi bi-arrow-repeat"></i> Generate 100 References
      </button>

      <div class="table-container">
        <table id="referenceTable">
          <thead>
            <tr>
              <th style="width: 10%">DOI</th>
              <th style="width: 10%">Title</th>
              <th style="width: 10%">Authors</th>
              <th style="width: 10%">Journal</th>
              <th style="width: 10%">Publisher</th>
              <th style="width: 10%">Type</th>
              <th style="width: 10%">URL</th>
              <th style="width: 5%">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty-state-row">
              <td colspan="8" class="empty-state">
                <i class="bi bi-journal-text"></i>
                <h3>No references generated yet</h3>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </section>

    <!-- Saved References Section -->
    <section id="savedSection" class="content-section">
      <div class="section-header">
        <h2 class="section-title">Saved References</h2>
        <div class="saved-actions">
          <button class="btn btn-primary btn-sm" onclick="generateAPACode()">
            <i class="bi bi-eye"></i> Preview APA Format
          </button>
          <button class="btn btn-success btn-sm" onclick="copyHTMLCode()">
            <i class="bi bi-clipboard"></i> Copy HTML to Clipboard
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <table id="savedTable">
          <thead>
            <tr>
              <th style="width: 10%">DOI</th>
              <th style="width: 25%">Title</th>
              <th style="width: 15%">Authors</th>
              <th style="width: 15%">Journal</th>
              <th style="width: 10%">Publisher</th>
              <th style="width: 10%">Type</th>
              <th style="width: 10%">URL</th>
              <th style="width: 5%">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr class="empty-state-row">
              <td colspan="8" class="empty-state">
                <i class="bi bi-bookmark-star"></i>
                <h3>No saved references yet</h3>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Preview Section -->
      <div class="preview-section" id="previewSection" style="display: none;">
        <div class="preview-header">
          <h3 class="preview-title">APA Format Preview</h3>
          <button class="btn btn-primary btn-sm" onclick="copyHTMLCode()">
            <i class="bi bi-clipboard"></i> Copy HTML
          </button>
        </div>
        <div class="preview-content" id="apaPreview"></div>
      </div>
    </section>
  </div>

  <script>
    let allRows = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    const savedDOIs = new Set();
    let dragSrcRow = null;

    // Show the selected tab and hide others
    function showTab(tabId) {
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.classList.remove('active-tab');
      });
      
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active-tab');
      
      // Hide preview section when switching tabs
      document.getElementById('previewSection').style.display = 'none';
    }

    // Initialize with generate tab visible
    window.onload = () => showTab('generateSection');

    // Fetch and generate references
    async function generateReferences() {
      try {
        const csvUrl = 'https://raw.githubusercontent.com/mayaabapo/journal-script/7f0f1747d2e241c3e7126c56e3e87834f12b4bbc/crossref_cannabis_20250402_120012_simple.csv';
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
          throw new Error('Failed to fetch references');
        }
        
        const csvText = await response.text();
        const rows = csvText.trim().split('\n');
        const headers = rows[0].split(',');
        const dataRows = rows.slice(1);

        allRows = [];
        const picked = new Set();
        
        // Get up to 100 random unique references
        while (allRows.length < 100 && picked.size < dataRows.length) {
          const i = Math.floor(Math.random() * dataRows.length);
          if (!picked.has(i)) {
            picked.add(i);
            allRows.push(dataRows[i]);
          }
        }

        window.headers = headers;
        currentPage = 1;
        renderTable();
        renderPagination();
        
        // Remove empty state if present
        const emptyState = document.querySelector('#referenceTable .empty-state-row');
        if (emptyState) {
          emptyState.remove();
        }
      } catch (error) {
        console.error('Error generating references:', error);
        alert('Failed to generate references. Please try again later.');
      }
    }

    // Render the table with pagination
    function renderTable() {
      const tbody = document.querySelector('#referenceTable tbody');
      tbody.innerHTML = '';
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageRows = allRows.slice(start, end);

      if (pageRows.length === 0) {
        tbody.innerHTML = `
          <tr class="empty-state-row">
            <td colspan="8" class="empty-state">
              <i class="bi bi-journal-text"></i>
              <h3>No references found</h3>
              <p>Try generating references again</p>
            </td>
          </tr>
        `;
        return;
      }

      pageRows.forEach(row => {
        const cells = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
        const get = name => cells[window.headers.indexOf(name)]?.replace(/^"|"$/g, '') || '';
        const doi = get('DOI');
        const isSaved = savedDOIs.has(doi);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${doi || 'N/A'}</td>
          <td>${get('title') || 'Untitled'}</td>
          <td>${get('author_names') || 'Unknown'}</td>
          <td>${get('container-title') || 'N/A'}</td>
          <td>${get('publisher') || 'Unknown'}</td>
          <td>${get('type') || 'Article'}</td>
          <td><a href="${get('URL')}" target="_blank" rel="noopener noreferrer">View</a></td>
          <td>
            <button class="btn ${isSaved ? 'btn-success' : 'btn-secondary'} btn-sm" 
                    data-doi="${doi}" 
                    onclick="saveRow(this)"
                    ${isSaved ? 'disabled' : ''}>
              ${isSaved ? '<i class="bi bi-check"></i> Saved' : '<i class="bi bi-bookmark-plus"></i> Save'}
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Render pagination controls
    function renderPagination() {
      const totalPages = Math.ceil(allRows.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';

      if (totalPages <= 1) return;

      // Previous button
      if (currentPage > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.innerHTML = '&laquo;';
        prevBtn.title = 'Previous page';
        prevBtn.onclick = () => {
          currentPage--;
          renderTable();
          renderPagination();
        };
        pagination.appendChild(prevBtn);
      }

      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      if (startPage > 1) {
        const firstBtn = document.createElement('button');
        firstBtn.textContent = '1';
        firstBtn.onclick = () => {
          currentPage = 1;
          renderTable();
          renderPagination();
        };
        pagination.appendChild(firstBtn);

        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0.5rem';
          pagination.appendChild(ellipsis);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        if (i === currentPage) btn.classList.add('active');
        btn.onclick = () => {
          currentPage = i;
          renderTable();
          renderPagination();
        };
        pagination.appendChild(btn);
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0.5rem';
          pagination.appendChild(ellipsis);
        }

        const lastBtn = document.createElement('button');
        lastBtn.textContent = totalPages;
        lastBtn.onclick = () => {
          currentPage = totalPages;
          renderTable();
          renderPagination();
        };
        pagination.appendChild(lastBtn);
      }

      // Next button
      if (currentPage < totalPages) {
        const nextBtn = document.createElement('button');
        nextBtn.innerHTML = '&raquo;';
        nextBtn.title = 'Next page';
        nextBtn.onclick = () => {
          currentPage++;
          renderTable();
          renderPagination();
        };
        pagination.appendChild(nextBtn);
      }
    }

    // Save a reference to the saved list
    function saveRow(button) {
      const doi = button.dataset.doi;
      if (!doi || savedDOIs.has(doi)) return;

      const row = button.closest('tr');
      const cells = Array.from(row.querySelectorAll('td')).map(td => td.cloneNode(true));
      cells.pop(); // Remove the action cell

      const savedTbody = document.querySelector('#savedTable tbody');
      
      // Remove empty state if present
      const emptyState = savedTbody.querySelector('.empty-state-row');
      if (emptyState) {
        emptyState.remove();
      }

      const savedRow = document.createElement('tr');
      savedRow.setAttribute('draggable', 'true');
      savedRow.style.cursor = 'move';
      
      // Add drag and drop event listeners
      savedRow.addEventListener('dragstart', handleDragStart);
      savedRow.addEventListener('dragover', handleDragOver);
      savedRow.addEventListener('drop', handleDrop);
      savedRow.addEventListener('dragleave', handleDragLeave);
      savedRow.addEventListener('dragend', handleDragEnd);

      cells.forEach(cell => savedRow.appendChild(cell));

      const removeBtn = document.createElement('button');
      removeBtn.className = 'btn btn-danger btn-sm';
      removeBtn.innerHTML = '<i class="bi bi-trash"></i> Remove';
      removeBtn.onclick = () => {
        savedRow.remove();
        savedDOIs.delete(doi);
        
        // Update the save button in the generate table
        const originalBtn = document.querySelector(`#referenceTable button[data-doi="${doi}"]`);
        if (originalBtn) {
          originalBtn.innerHTML = '<i class="bi bi-bookmark-plus"></i> Save';
          originalBtn.className = 'btn btn-secondary btn-sm';
          originalBtn.disabled = false;
        }
        
        // Show empty state if no saved references left
        if (savedTbody.querySelectorAll('tr').length === 0) {
          savedTbody.innerHTML = `
            <tr class="empty-state-row">
              <td colspan="8" class="empty-state">
                <i class="bi bi-bookmark-star"></i>
                <h3>No saved references</h3>
                <p>Generate references and save them to appear here</p>
              </td>
            </tr>
          `;
          document.getElementById('previewSection').style.display = 'none';
        }
      };

      const removeCell = document.createElement('td');
      removeCell.appendChild(removeBtn);
      savedRow.appendChild(removeCell);

      savedTbody.appendChild(savedRow);
      savedDOIs.add(doi);

      // Update the button in the generate table
      button.innerHTML = '<i class="bi bi-check"></i> Saved';
      button.className = 'btn btn-success btn-sm';
      button.disabled = true;
    }

    /* Drag and Drop Functions */
    function handleDragStart(e) {
      dragSrcRow = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.style.opacity = '0.4';
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      this.classList.add('drag-over');
      return false;
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (dragSrcRow !== this) {
        const tbody = this.parentNode;
        const rows = Array.from(tbody.children);
        const srcIndex = rows.indexOf(dragSrcRow);
        const targetIndex = rows.indexOf(this);
        
        if (srcIndex < targetIndex) {
          tbody.insertBefore(dragSrcRow, this.nextSibling);
        } else {
          tbody.insertBefore(dragSrcRow, this);
        }
      }
      
      this.classList.remove('drag-over');
      return false;
    }

    function handleDragLeave(e) {
      this.classList.remove('drag-over');
    }

    function handleDragEnd(e) {
      this.style.opacity = '1';
      document.querySelectorAll('#savedTable tr').forEach(row => {
        row.classList.remove('drag-over');
      });
    }

    // Generate APA formatted references
    function generateAPACode() {
      const rows = document.querySelectorAll('#savedTable tbody tr');
      
      if (rows.length === 0) {
        alert('No saved references to generate APA format');
        return;
      }

      let html = `
<h2 style="font-size: 1.8em; color: black; margin-top:10px; margin-bottom: 1rem; border-bottom: 2px solid; padding-bottom: 0.5rem;">Further Reading</h2>
<div style="overflow-x: auto; margin-bottom: 20px">
  <table style="border-collapse: collapse; width: 100%; font-family: 'Inter', sans-serif; font-size: 1.1em !important; line-height: 1.6;">
    <tbody>
`;

      let preview = `
<h2 style="font-size: 1.8rem; color: black; margin-bottom: 1rem; border-bottom: 2px ; padding-bottom: 0.5rem;">Further Reading</h2>
<div style="overflow-x: auto;">
  <table style="border-collapse: collapse; width: 100%; font-family: 'Inter', sans-serif; font-size: 1em; line-height: 1.6;">
    <tbody>
`;

      rows.forEach((row, index) => {
        const cells = row.querySelectorAll('td');
        const title = cells[1]?.innerText || '';
        const authors = cells[2]?.innerText || '';
        const container = cells[3]?.innerText || '';
        const year = 'n.d.';
        const doi = cells[0]?.innerText || '';
        
        // Format authors (convert "First M. Last" to "Last, F. M.")
        let formattedAuthors = authors.split(',').map(author => {
          author = author.trim();
          if (!author) return '';
          
          // Split into parts and remove empty strings
          const parts = author.split(/\s+/).filter(part => part.trim());
          
          if (parts.length === 0) return '';
          
          // Last name is the last part
          const lastName = parts[parts.length - 1];
          
          // First and middle initials
          const initials = parts.slice(0, -1).map(name => {
            // If part ends with . (like "J."), use as is
            if (name.endsWith('.')) return name;
            // Otherwise take first letter and add .
            return name[0] ? `${name[0]}.` : '';
          }).join(' ');
          
          return `${lastName}, ${initials}`;
        }).filter(a => a);

        // Handle the "and" before last author if more than one
        if (formattedAuthors.length > 1) {
          const lastAuthor = formattedAuthors.pop();
          formattedAuthors = formattedAuthors.join(', ') + ', & ' + lastAuthor;
        } else {
          formattedAuthors = formattedAuthors.join(', ');
        }

        // If no authors formatted, use "Anonymous"
        if (!formattedAuthors) {
          formattedAuthors = 'Anonymous';
        }
        
        // Format the reference
        const formatted = `${formattedAuthors} (${year}). <i>${title}</i>. ${container}. https://doi.org/${doi}`;

        html += `
      <tr>
        <td style="padding: 8px; vertical-align: top; width: 5%; white-space: nowrap;">[${index + 1}]</td>
        <td style="padding: 8px; vertical-align: top;">${formatted}</td>
      </tr>
`;
        preview += `
      <tr>
        <td style="padding: 8px; vertical-align: top; width: 5%; white-space: nowrap;">[${index + 1}]</td>
        <td style="padding: 8px; vertical-align: top;">${formatted}</td>
      </tr>
`;
      });

      html += '    </tbody>\n  </table>\n</div>';
      preview += '    </tbody></table></div>';

      document.getElementById('apaPreview').innerHTML = preview;
      document.getElementById('previewSection').style.display = 'block';
      
      // Scroll to preview section
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Copy HTML code to clipboard
    function copyHTMLCode() {
      const previewContent = document.getElementById('apaPreview').innerHTML;
      if (!previewContent) {
        alert('No references to copy. Please generate APA preview first.');
        return;
      }

      const html = `
<h2 style="font-size: 1.8em; color: black; margin-top:10px; margin-bottom: 1rem; border-bottom: 2px solid ; padding-bottom: 0.5rem;">Further Reading</h2>
<div style="overflow-x: auto; margin-bottom: 20px">
  <table style="border-collapse: collapse; width: 100%; font-family: 'Inter', sans-serif; font-size: 1.1em !important; line-height: 1.6;">
    <tbody>
      ${document.getElementById('apaPreview').querySelector('tbody').innerHTML}
    </tbody>
  </table>
</div>
`;

      navigator.clipboard.writeText(html)
        .then(() => {
          alert('HTML code copied to clipboard!');
        })
        .catch(err => {
          console.error('Failed to copy:', err);
          alert('Failed to copy HTML to clipboard. Please try again.');
        });
    }
  </script>
</body>
</html>